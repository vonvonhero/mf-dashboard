name: Money Forward Daily Update

on:
  schedule:
    # JST 6:50 → UTC 21:50 (前日)
    - cron: "50 21 * * *"
    # JST 15:20 → UTC 6:20
    - cron: "20 6 * * *"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: "daily-update"
  cancel-in-progress: false

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.check.outputs.should-run }}
    steps:
      - id: check
        env:
          OP_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          RUN_TASK: ${{ vars.RUN_TASK }}
        run: echo "should-run=${{ env.OP_TOKEN != '' && env.RUN_TASK == 'true' }}" >> $GITHUB_OUTPUT

  update:
    needs: check
    if: needs.check.outputs.should-run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-node
      - uses: ./.github/actions/auth-state-cache
        with:
          mode: restore
          enabled: ${{ vars.CACHE_AUTH_STATE }}
      - run: pnpm --filter @mf-dashboard/crawler start
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          OP_VAULT: ${{ secrets.OP_VAULT }}
          OP_ITEM: ${{ secrets.OP_ITEM }}
          OP_TOTP_FIELD: ${{ secrets.OP_TOTP_FIELD }}
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
          DASHBOARD_URL: ${{ secrets.DASHBOARD_URL }}
      - uses: ./.github/actions/auth-state-cache
        if: always()
        with:
          mode: save
          enabled: ${{ vars.CACHE_AUTH_STATE }}
      - run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/moneyforward.db
          git diff --cached --quiet || git commit -m "chore: update database"
          git push
