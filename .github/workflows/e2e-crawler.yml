name: Crawler E2E Tests

on:
  schedule:
    # JST 12:00 (UTC 03:00)
    - cron: "0 3 * * *"
  workflow_dispatch:

concurrency:
  group: "e2e-crawler"
  cancel-in-progress: true

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.check.outputs.should-run }}
    steps:
      - id: check
        env:
          OP_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          SHOULD_RUN: ${{ vars.SHOULD_RUN_CRAWLER_E2E }}
        run: echo "should-run=${{ env.OP_TOKEN != '' && env.SHOULD_RUN == 'true' }}" >> $GITHUB_OUTPUT
  e2e:
    needs: check
    if: needs.check.outputs.should-run == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-node
      - uses: ./.github/actions/auth-state-cache
        with:
          mode: restore
          enabled: ${{ vars.CACHE_AUTH_STATE }}
      - name: Run e2e tests
        run: pnpm --filter @mf-dashboard/crawler test:e2e
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          OP_VAULT: ${{ secrets.OP_VAULT }}
          OP_ITEM: ${{ secrets.OP_ITEM }}
          OP_TOTP_FIELD: ${{ secrets.OP_TOTP_FIELD }}
      - uses: ./.github/actions/auth-state-cache
        if: always()
        with:
          mode: save
          enabled: ${{ vars.CACHE_AUTH_STATE }}
      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: e2e-screenshots
          path: apps/crawler/tests/e2e/screenshots/
          if-no-files-found: ignore
      - name: Notify Slack on failure
        if: failure()
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ secrets.SLACK_CHANNEL_ID }}
            text: "ğŸ”´ Crawler E2E ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"
            blocks:
              - type: section
                text:
                  type: mrkdwn
                  text: |
                    *ğŸ”´ Crawler E2E ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ*

                    <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ç¢ºèª>
